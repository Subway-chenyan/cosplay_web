# 数据清理脚本使用说明

本目录包含用于清理Cosplay数据库的脚本，请谨慎使用！

## 📁 脚本文件

### 1. `delete_all_data.py` - 交互式删除脚本
- **功能**: 删除数据库中所有数据（保留超级用户）
- **特点**: 需要用户确认，显示详细统计信息
- **安全性**: 高（需要输入'DELETE'确认）

### 2. `delete_all_data_force.py` - 强制删除脚本
- **功能**: 立即删除所有数据，无需确认
- **特点**: 快速执行，适合自动化脚本
- **安全性**: 低（立即执行，请谨慎使用）

## 🗑️ 删除的数据类型

脚本将按以下顺序删除数据（遵循外键依赖关系）：

1. **获奖记录** (AwardRecord) - 依赖奖项、视频、社团
2. **奖项** (Award) - 依赖比赛
3. **视频标签关联** (VideoTag) - 依赖视频和标签
4. **视频** (Video) - 依赖社团、比赛、用户
5. **标签** (Tag)
6. **社团** (Group)
7. **比赛** (Competition)
8. **普通用户** (User) - 保留超级用户

## 🔒 保留的数据

- **超级用户账户** - 确保系统管理功能正常
- **Django系统表** - 保持系统完整性

## 🚀 使用方法

### 方法1: 交互式删除（推荐）

```bash
# 进入后端目录
cd /home/ubuntu/cosplay_web/backend

# 运行交互式删除脚本
python delete_all_data.py
```

**执行流程**:
1. 显示当前数据统计
2. 显示警告信息
3. 要求输入'DELETE'确认
4. 执行删除操作
5. 显示删除结果

### 方法2: 强制删除（谨慎使用）

```bash
# 进入后端目录
cd /home/ubuntu/cosplay_web/backend

# 运行强制删除脚本
python delete_all_data_force.py
```

**执行流程**:
1. 立即开始删除
2. 显示删除前统计
3. 执行删除操作
4. 显示删除结果

### 方法3: 使用可执行权限

```bash
# 添加执行权限
chmod +x delete_all_data.py
chmod +x delete_all_data_force.py

# 直接执行
./delete_all_data.py
./delete_all_data_force.py
```

## ⚠️ 重要注意事项

### 安全提醒
- **不可逆操作**: 删除的数据无法恢复
- **生产环境**: 请勿在生产环境中使用
- **备份**: 删除前请确保已备份重要数据

### 使用场景
- 开发环境重置
- 测试数据清理
- 重新导入数据前的准备

### 错误处理
- 脚本使用数据库事务，出错时会自动回滚
- 如果删除失败，数据保持原状
- 检查错误信息并解决问题后重试

## 🔄 删除后的操作

### 1. 重新导入数据
```bash
# 使用数据导入脚本
cd upload_data
python import_data.py your_data_file.xlsx
```

### 2. 创建新的超级用户
```bash
# 如果需要新的管理员账户
python manage.py createsuperuser
```

### 3. 重新初始化数据
```bash
# 运行初始化脚本（如果有）
python create_test_data.py
```

## 📊 示例输出

### 交互式删除示例
```
🗑️  Cosplay数据库清理工具
==================================================

⚠️  警告：此操作将删除数据库中的所有数据！
📊 将要删除的数据包括：
   - 所有视频记录
   - 所有社团信息
   - 所有比赛信息
   - 所有奖项和获奖记录
   - 所有标签和标签关联
   - 所有用户账户（除超级用户外）

📈 当前数据统计：
   - 视频: 15 条
   - 社团: 8 个
   - 比赛: 3 个
   - 奖项: 12 个
   - 获奖记录: 25 条
   - 标签: 20 个
   - 视频标签关联: 45 条
   - 用户: 5 个 (其中超级用户: 1 个)

🔒 注意：超级用户账户将被保留

确认删除所有数据吗？请输入 'DELETE' 来确认，或输入 'n' 取消: DELETE

==================================================
🗑️  开始删除数据...

🔄 删除获奖记录...
✅ 已删除 25 条获奖记录
🔄 删除奖项...
✅ 已删除 12 个奖项
🔄 删除视频标签关联...
✅ 已删除 45 条视频标签关联
🔄 删除视频...
✅ 已删除 15 个视频
🔄 删除标签...
✅ 已删除 20 个标签
🔄 删除社团...
✅ 已删除 8 个社团
🔄 删除比赛...
✅ 已删除 3 个比赛
🔄 删除普通用户（保留超级用户）...
✅ 已删除 4 个普通用户
🔒 保留了 1 个超级用户

🎉 所有数据删除完成！
⏰ 删除时间: 2024-01-15 14:30:25

==================================================
✅ 数据库清理完成！
💡 提示：您可以重新运行数据导入脚本来添加新数据
```

## 🛠️ 故障排除

### 常见错误

1. **导入错误**
   ```
   ❌ 导入错误: No module named 'django'
   ```
   **解决**: 确保在正确的Python环境中运行，激活虚拟环境

2. **权限错误**
   ```
   ❌ 删除过程中发生错误: permission denied
   ```
   **解决**: 检查数据库连接权限和文件权限

3. **数据库连接错误**
   ```
   ❌ 导入错误: could not connect to server
   ```
   **解决**: 确保数据库服务正在运行，检查连接配置

### 调试模式

如果需要调试，可以在脚本中添加详细日志：

```python
# 在脚本开头添加
import logging
logging.basicConfig(level=logging.DEBUG)
```

## 📞 支持

如果遇到问题：
1. 检查错误信息
2. 确认环境配置
3. 查看Django日志
4. 联系开发团队

---

**最后提醒**: 这些脚本具有破坏性，请在使用前确保您了解其影响！